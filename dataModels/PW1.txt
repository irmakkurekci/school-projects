CREATE MATERIALIZED VIEW MV_DIM_ATHLETES 
BUILD IMMEDIATE 
REFRESH COMPLETE ON DEMAND 
AS 
SELECT  
    C.ID, 
    C.ATHLETE_NAME, 
    C.ATHLETE_GENDER 
FROM  
    OLYM.OLYM_ATHLETES C
;

CREATE MATERIALIZED VIEW MV_DIM_GAMES 
BUILD IMMEDIATE 
REFRESH COMPLETE ON DEMAND 
AS 
SELECT  
    C.ID, 
    C.YEAR, 
    C.SEASON, 
    C.CITY 
FROM  
    OLYM.OLYM_GAMES C
;

CREATE MATERIALIZED VIEW MVI_ATHLETE_PERFORMANCE AS 
SELECT 
    ag.ID AS ATHLETE_GAME_ID, 
    e.ID AS EVENT_ID, 
    COUNT(m.ID) AS MEDALS_WON 
FROM 
    OLYM.OLYM_ATHLETE_GAMES ag 
JOIN OLYM.OLYM_ATHLETES a ON ag.ATHLETE_ID = a.ID 
JOIN OLYM.OLYM_GAMES g ON ag.GAME_ID = g.ID 
JOIN OLYM.OLYM_NATIONS n ON ag.NATION_ID = n.ID 
LEFT JOIN OLYM.OLYM_MEDALS m ON ag.ID = m.ATHLETE_GAME_ID 
JOIN OLYM.OLYM_EVENTS e ON m.EVENT_ID = e.ID    
JOIN OLYM.OLYM_BASE_EVENTS b ON e.BASE_EVENT_ID = b.ID 
 
GROUP BY 
    ag.ID, a.ID, g.ID, e.ID, n.ID, b.ID
;

CREATE MATERIALIZED VIEW MV_NATIONS AS 
SELECT 
    ID AS NATION_ID, 
    NATION 
FROM 
    OLYM.OLYM_NATIONS
;

CREATE MATERIALIZED VIEW MV_EVENTS AS 
SELECT 
    ID AS EVENT_ID, 
    EVENT_GENDER, 
    BASE_EVENT_ID 
FROM 
    OLYM.OLYM_EVENTS
;

CREATE MATERIALIZED VIEW MV_BASE_EVENTS AS 
SELECT 
    ID AS BASE_EVENT_ID, 
    DISCIPLINE_ID, 
    EVENT 
FROM 
    OLYM.OLYM_BASE_EVENTS
;

CREATE MATERIALIZED VIEW MV_MEDALS AS 
SELECT 
    ID AS MEDAL_ID, 
    ATHLETE_GAME_ID, 
    MEDAL 
FROM 
    OLYM.OLYM_MEDALS
;

CREATE MATERIALIZED VIEW MV_ATHLETE_GAMES AS 
SELECT 
    ID AS ATHLETE_GAME_ID, 
    ATHLETE_ID, 
    GAME_ID, 
    NATION_ID 
FROM 
    OLYM.OLYM_ATHLETE_GAMES
;

SELECT 
    n.NATION AS Nation, 
    g.YEAR AS Year, 
    COUNT(m.MEDAL) AS Total_Medals 
FROM 
    OLYM.OLYM_MEDALS m 
JOIN 
    OLYM.OLYM_ATHLETE_GAMES ag ON m.ATHLETE_GAME_ID = ag.ID 
JOIN 
    OLYM.OLYM_NATIONS n ON ag.NATION_ID = n.ID 
JOIN 
    OLYM.OLYM_GAMES g ON ag.GAME_ID = g.ID 
GROUP BY 
    ROLLUP(n.NATION, g.YEAR)
;

SELECT  
    g.YEAR AS Year,  
    e.EVENT_GENDER AS Event_Gender,  
    COUNT(m.MEDAL) AS Total_Medals  
FROM  
    OLYM.OLYM_MEDALS m  
JOIN  
    OLYM.OLYM_ATHLETE_GAMES ag ON m.ATHLETE_GAME_ID = ag.ID  
JOIN  
    OLYM.OLYM_NATIONS n ON ag.NATION_ID = n.ID  
JOIN  
    OLYM.OLYM_GAMES g ON ag.GAME_ID = g.ID  
JOIN  
    MVI_ATHLETE_PERFORMANCE f ON f.ATHLETE_GAME_ID = ag.ID  
JOIN  
    OLYM.OLYM_EVENTS e ON f.EVENT_ID = e.ID  
GROUP BY  
    CUBE(n.NATION, g.YEAR, e.EVENT_GENDER)
;

SELECT 
    n.NATION AS Nation, 
    g.YEAR AS Year, 
    COUNT(m.MEDAL) AS Yearly_Medals, 
    SUM(COUNT(m.MEDAL)) OVER (PARTITION BY n.NATION ORDER BY g.YEAR) AS Running_Total 
FROM 
    OLYM.OLYM_MEDALS m 
JOIN 
    OLYM.OLYM_ATHLETE_GAMES ag ON m.ATHLETE_GAME_ID = ag.ID 
JOIN 
    OLYM.OLYM_NATIONS n ON ag.NATION_ID = n.ID 
JOIN 
    OLYM.OLYM_GAMES g ON ag.GAME_ID = g.ID 
GROUP BY 
    n.NATION, g.YEAR 
ORDER BY 
    n.NATION, g.YEAR
;

SELECT 
    NATION, 
    YEAR, 
    TOTAL_MEDALS 
FROM ( 
    SELECT 
        n.NATION AS NATION, 
        g.YEAR AS YEAR, 
        COUNT(m.MEDAL) AS TOTAL_MEDALS 
    FROM 
        OLYM.OLYM_MEDALS m 
    JOIN 
        OLYM.OLYM_ATHLETE_GAMES ag ON m.ATHLETE_GAME_ID = ag.ID 
    JOIN 
        OLYM.OLYM_NATIONS n ON ag.NATION_ID = n.ID 
    JOIN 
        OLYM.OLYM_GAMES g ON ag.GAME_ID = g.ID 
    GROUP BY 
        n.NATION, g.YEAR 
) 
MODEL 
    PARTITION BY (NATION) 
    DIMENSION BY (YEAR) 
    MEASURES (TOTAL_MEDALS, 0 AS RUNNING_TOTAL) 
    RULES ( 
        RUNNING_TOTAL[YEAR > 0] = RUNNING_TOTAL[CV() - 1] + TOTAL_MEDALS[CV()] 
    ) 
ORDER BY 
    NATION, YEAR
;

SELECT ATHLETE_NAME, NATION, EVENT_GENDER, PREDICTED_MEDALS 
FROM ( 
    SELECT  
        ATH.ATHLETE_NAME, 
        N.NATION, 
        E.EVENT_GENDER, 
        COUNT(M.MEDAL) AS TOTAL_MEDALS 
    FROM  
        OLYM.OLYM_ATHLETES ATH 
    JOIN  
        OLYM.OLYM_ATHLETE_GAMES AG ON ATH.ID = AG.ATHLETE_ID 
    JOIN  
        OLYM.OLYM_MEDALS M ON AG.ID = M.ATHLETE_GAME_ID 
    JOIN  
        OLYM.OLYM_EVENTS E ON M.EVENT_ID = E.ID 
    JOIN  
        OLYM.OLYM_NATIONS N ON AG.NATION_ID = N.ID 
    JOIN  
        OLYM.OLYM_GAMES G ON AG.GAME_ID = G.ID 
    WHERE  
        G.SEASON = 'Summer' 
    GROUP BY  
        ATH.ATHLETE_NAME, N.NATION, E.EVENT_GENDER 
) 
MODEL 
    PARTITION BY (ATHLETE_NAME, NATION) 
    DIMENSION BY (EVENT_GENDER) 
    MEASURES (TOTAL_MEDALS, 0 AS PREDICTED_MEDALS) 
    RULES UPSERT ( 
        PREDICTED_MEDALS[ANY] = TOTAL_MEDALS[CV(EVENT_GENDER)] + 1 
    ) 
ORDER BY PREDICTED_MEDALS DESC 
FETCH FIRST 5 ROWS ONLY
;
